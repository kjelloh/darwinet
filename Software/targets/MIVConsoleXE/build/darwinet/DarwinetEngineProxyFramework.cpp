//---------------------------------------------------------------------------

#pragma hdrstop

#include "DarwinetEngineProxyFramework.h"
#include "BusinessLogUnit.h"

//---------------------------------------------------------------------------
#pragma package(smart_init)

//---------------------------------------------------------------------------
// #include "DarwinetCOMServer_TLB.h" // Type Library wrappers generated by RAD Studio
#include "DarwinetCOMServer_OCX.h" // VCL Components wrapping Automation COM Objects imported from Type Library
//---------------------------------------------------------------------------

/**
  * Implements a proxy to a Darwinet Domain COM object
  */
class c_DarwinetDomainCOMWrapperProxyImpl : public c_DarwinetDomainProxy {
public:
	/**
	  * Constructor
	  */
	c_DarwinetDomainCOMWrapperProxyImpl(TDarwinetDomain* pDarwinetDomain)
		: m_pDarwinetDomain(pDarwinetDomain)
	{
		try {
			m_pDarwinetDomain->Connect();
		}
		CATCH_AND_LOG_IDE_STD_AND_GENERAL_EXCEPTION_DESIGN_INSUFFICIENCY;
	}

	/**
	  * Virtual destructor
	  */
	virtual ~c_DarwinetDomainCOMWrapperProxyImpl() {
		try {
			m_pDarwinetDomain->Disconnect();
		}
		CATCH_AND_LOG_IDE_STD_AND_GENERAL_EXCEPTION_DESIGN_INSUFFICIENCY;
	}
private:

	/**
	  * Private storage of our COM wrapper to Darwinet Domain object
	  */
	TDarwinetDomain* m_pDarwinetDomain;

};

/**
  * Implements a Proxy using the Darwinet Engine COM Interface
  * through RAD Studio XE Automation COM Object wrappers
  */
class c_AutomationCOMWrapperProxyImpl : public c_DarwinetEngineProxy {
public:

	/**
	  * Constructor
	  */
	c_AutomationCOMWrapperProxyImpl()
		: m_pDarwinetEngine(new TDarwinetEngine(Application))
	{
		m_pDarwinetEngine->Connect();
	}

	~c_AutomationCOMWrapperProxyImpl() {
		m_pDarwinetEngine->Disconnect();
	}

	// begin c_DarwinetEngineProxy

	/**
	  * Returns a Domain hosted by the Engine
	  */
	c_DarwinetDomainProxy::shared_ptr getDomain(/* TODO: Provide path of the domain to return */) {
		if (!m_pDarwinetDomainProxy) {
			TDarwinetDomain* pDarwinetDomainCOMWrapper(new TDarwinetDomain(Application));
			pDarwinetDomainCOMWrapper->ConnectTo(m_pDarwinetEngine->getDomain());
			m_pDarwinetDomainProxy.reset(new c_DarwinetDomainCOMWrapperProxyImpl(pDarwinetDomainCOMWrapper));
		}
		return m_pDarwinetDomainProxy;
	};

	// End c_DarwinetEngineProxy

private:

	/**
	  * Private storage of our Darwinet Engine Component
	  */
	TDarwinetEngine* m_pDarwinetEngine;

	/**
	  * Private storage of our cashed Domain proxy
	  */
	c_DarwinetDomainProxy::shared_ptr m_pDarwinetDomainProxy;

};

/**
  * Returns a shared pointer to a Proxy using the Darwinet Engine COM Interface
  * through RAD Studio XE Automation COM Object wrappers
  */
c_DarwinetEngineProxy::shared_ptr createAutomationCOMWrapperProxy() {
	c_DarwinetEngineProxy::shared_ptr result(new c_AutomationCOMWrapperProxyImpl());
	return result;
}



/**
  * Factory Method that creates the Darwinet Engine to be used by the Client.
  */
c_DarwinetEngineProxy::shared_ptr c_DarwinetEngineFactory::createDarwinetEngine() {
	// Deafult to use COM interface
	return createAutomationCOMWrapperProxy();
}
